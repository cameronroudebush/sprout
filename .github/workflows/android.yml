name: Android CI/CD

permissions:
  contents: write
  pull-requests: read

on:
  push:
    branches: ["master"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["*"]

jobs:
  # ------------------------------------------------------------------------------------
  # Filter: Decides if any work needs to happen based on file changes
  # ------------------------------------------------------------------------------------
  filter:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decision.outputs.should_run }}
    steps:
      - name: Check if this is a tag push
        id: check_tag
        run: echo "is_tag=${{ startsWith(github.ref, 'refs/tags/') }}" >> $GITHUB_OUTPUT

      - name: Checkout for path analysis
        if: steps.check_tag.outputs.is_tag == 'false'
        uses: actions/checkout@v6

      - name: Get changed files in frontend
        if: steps.check_tag.outputs.is_tag == 'false'
        id: changed_files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            frontend/**

      - name: Decide whether to proceed
        id: decision
        run: |
          if [[ "${{ steps.check_tag.outputs.is_tag }}" == "true" || "${{ steps.changed_files.outputs.any_changed }}" == "true" ]]; then
            echo "Proceeding: A tag was pushed or relevant files changed."
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "Skipping: Not a tag push and no changes in frontend/."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # ------------------------------------------------------------------------------------
  # Build: Runs for PRs, Master, and Tags (Verification Only)
  # ------------------------------------------------------------------------------------
  build:
    needs: filter
    if: needs.filter.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      version_string: ${{ steps.get_repo_info.outputs.version_string }}
      android_changelog: ${{ steps.generate_changelogs.outputs.android_changelog }}
    env:
      ANDROID_SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          lfs: "true"

      - name: Get Repo Info
        id: get_repo_info
        uses: ./.github/actions/get-repo-info
        with:
          fetch-depth: "0"

      - name: Generate Changelogs
        id: generate_changelogs
        uses: ./.github/actions/generate-changelog
        with:
          starting-version: ${{ steps.get_repo_info.outputs.version_string }}

      - name: Set up Environment (Java/Flutter)
        uses: actions/setup-java@v5
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.x"
          channel: "stable"
          cache: true

      - name: Build App Bundle (AAB)
        working-directory: ./frontend
        run: |
          flutter pub get

          # Decode Keystore
          echo "${{ secrets.ANDROID_SIGNING_KEY }}" | base64 --decode > android/app/upload-keystore.jks

          # Update so current shell sees the path
          export ANDROID_SIGNING_KEYSTORE_PATH="$GITHUB_WORKSPACE/frontend/android/app/upload-keystore.jks"

          # Also write to GITHUB_ENV for any future steps if needed
          echo "ANDROID_SIGNING_KEYSTORE_PATH=$ANDROID_SIGNING_KEYSTORE_PATH" >> $GITHUB_ENV

          chmod +x ../scripts/build_app.sh
          ../scripts/build_app.sh appbundle

      - name: Build and Rename APK (Tags Only)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          ../scripts/build_app.sh apk
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/sprout.apk
        working-directory: ./frontend

      # We upload the bundle so the 'deploy' job can grab it without rebuilding
      - name: Upload Bundle for Deployment
        uses: actions/upload-artifact@v6
        with:
          name: android-build-artifacts
          path: |
            frontend/build/app/outputs/bundle/release/app-release.aab
            frontend/build/app/outputs/flutter-apk/sprout.apk

  # ------------------------------------------------------------------------------------
  # Deploy: ONLY runs on Master or Tags
  # ------------------------------------------------------------------------------------
  deploy:
    needs: [filter, build]
    # Explicitly restrict to Master or Tags
    if: |
      needs.filter.outputs.should_run == 'true' && 
      (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    steps:
      - name: Download Bundle
        uses: actions/download-artifact@v7
        with:
          name: android-build-artifacts
          path: .

      - id: auth
        name: Authenticate with Google Cloud
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.SERVICE_ACCOUNT_JSON }}

      - name: Deploy to Google Play (QA/Alpha)
        if: github.ref == 'refs/heads/master'
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJson: ${{ steps.auth.outputs.credentials_file_path }}
          packageName: net.croudebush.sprout
          releaseFiles: frontend/build/app/outputs/bundle/release/app-release.aab
          track: alpha
          status: completed
          inAppUpdatePriority: 5
          whatsNewDirectory: whatsnew

      - name: Upload APK to Draft Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: "frontend/build/app/outputs/flutter-apk/sprout.apk"
          tag_name: ${{ needs.build.outputs.version_string }}
          draft: true

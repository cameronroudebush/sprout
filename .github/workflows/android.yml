name: Build and Release Android APK

on:
  workflow_run:
    workflows: ["Create GitHub Release"]
    types:
      - completed

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write

    env:
      ANDROID_SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_SIGNING_KEY_ALIAS }}
      ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
      ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: "true"

      - name: Get Repo Info
        id: get_repo_info
        uses: ./.github/actions/get-repo-info
        with:
          fetch-depth: "0"
          lfs: "true"

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.x"
          channel: "stable"

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Decode Keystore
        env:
          ENCODED_STRING: ${{ secrets.ANDROID_SIGNING_KEY }}
        run: |
          echo $ENCODED_STRING | base64 --decode > android/app/upload-keystore.jks

      - name: Set Keystore Path
        run: |
          echo "ANDROID_SIGNING_KEYSTORE_PATH=$GITHUB_WORKSPACE/android/app/upload-keystore.jks" >> $GITHUB_ENV

      - name: Build Android APK
        run: flutter build apk --release --no-tree-shake-icons --build-name=${{ steps.get_repo_info.outputs.version_string }}

      - name: Build Android App Bundle (AAB)
        run: flutter build appbundle --release --no-tree-shake-icons --build-name=${{ steps.get_repo_info.outputs.version_string }}

      - name: Upload to Google Play Store (Closed Beta)
        uses: r0adkll/upload-google-play@v1
        with:
          packageName: com.your.app.package
          serviceAccountJson: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          releaseFile: build/app/outputs/bundle/release/app-release.aab
          track: qa # TODO
          status: completed

      - name: Rename APK for Release
        run: |
          VERSION="${{ steps.get_repo_info.outputs.version_string }}"
          mv build/app/outputs/flutter-apk/app-release.apk "build/app/outputs/flutter-apk/sprout-$VERSION.apk"

      - name: Upload APK to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: "build/app/outputs/flutter-apk/sprout-${{ steps.get_repo_info.outputs.version_string }}.apk"
          tag_name: ${{ steps.get_repo_info.outputs.version_string }}
          body: ""
          draft: true
          prerelease: false
          update_existing: true

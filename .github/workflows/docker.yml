name: Build and Publish Docker Image

permissions:
  contents: write

on:
  push:
    branches: ["master"]
    tags:
      - "v*.*.*"
    paths:
      - "frontend/**"
      - "backend/**"
  pull_request:
    branches: ["*"] # Run on all branches for a pull request
    paths:
      - "frontend/**"
      - "backend/**"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: "true"

      - name: Get Repo Info
        id: get_repo_info
        uses: ./.github/actions/get-repo-info
        with:
          fetch-depth: "0"

      - name: NPM Install
        run: npm i --only=dev && npm i --prefix ./backend --only=dev

      - name: Login to Docker Hub
        if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker Image
        run: |
          IMAGE_NAME="croudebush/sprout"
          npm run build:docker $IMAGE_NAME:dev

      - name: Push 'dev' tag to Docker Hub
        if: github.ref == 'refs/heads/master'
        run: |
          IMAGE_NAME="croudebush/sprout"
          docker push $IMAGE_NAME:dev

      - name: Tag and Push Version and Stable Tags
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          IMAGE_NAME="croudebush/sprout"
          TAG_VERSION="${{ steps.get_repo_info.outputs.version_string }}"
          docker tag $IMAGE_NAME:dev $IMAGE_NAME:$TAG_VERSION
          docker push $IMAGE_NAME:$TAG_VERSION
          docker tag $IMAGE_NAME:dev $IMAGE_NAME:stable
          docker push $IMAGE_NAME:stable

      - name: Update Docker Hub Description
        if: startsWith(github.ref, 'refs/tags/')
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: croudebush/sprout

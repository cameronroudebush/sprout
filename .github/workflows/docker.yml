name: Build and Publish Docker Image

permissions:
  contents: write

on:
  push:
    branches: ["master"]
    tags:
      - "v*.*.*"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Get Repo Info
        id: get_repo_info
        uses: ./.github/actions/get-repo-info
        with:
          fetch-depth: "0"
          lfs: "true"

      - name: NPM Install
        run: npm i --only=dev && npm i --prefix ./backend --only=dev

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Publish 'dev' tag
        run: |
          IMAGE_NAME="croudebush/sprout"
          npm run build:docker $IMAGE_NAME:dev
          docker push $IMAGE_NAME:dev

      - name: Tag and Publish Version and Stable Tags
        if: ${{ steps.get_repo_info.outputs.is_tagged_commit == 'true' }}
        run: |
          IMAGE_NAME="croudebush/sprout"
          TAG_VERSION="${{ steps.get_repo_info.outputs.version_string }}"
          docker tag $IMAGE_NAME:dev $IMAGE_NAME:$TAG_VERSION
          docker push $IMAGE_NAME:$TAG_VERSION
          docker tag $IMAGE_NAME:dev $IMAGE_NAME:stable
          docker push $IMAGE_NAME:stable

      - name: Update Docker Hub Description
        if: ${{ steps.get_repo_info.outputs.is_tagged_commit == 'true' }}
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: croudebush/sprout

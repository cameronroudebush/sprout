name: Docker Container CI/CD

permissions:
  contents: write
  pull-requests: read

on:
  push:
    branches: ["master"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["*"]

jobs:
  # ------------------------------------------------------------------------------------
  # Filter: Decides if work is needed
  # ------------------------------------------------------------------------------------
  filter:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decision.outputs.should_run }}
    steps:
      - name: Check if this is a tag push
        id: check_tag
        run: echo "is_tag=${{ startsWith(github.ref, 'refs/tags/') }}" >> $GITHUB_OUTPUT

      - name: Checkout for path analysis
        if: steps.check_tag.outputs.is_tag == 'false'
        uses: actions/checkout@v6

      - name: Get changed files
        if: steps.check_tag.outputs.is_tag == 'false'
        id: changed_files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            frontend/**
            backend/**
            dockerfile
            .dockerignore

      - name: Decide whether to proceed
        id: decision
        run: |
          if [[ "${{ steps.check_tag.outputs.is_tag }}" == "true" || "${{ steps.changed_files.outputs.any_changed }}" == "true" ]]; then
            echo "Proceeding: A tag was pushed or relevant files changed."
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "Skipping: Not a tag push and no changes in frontend/ or backend/."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  # ------------------------------------------------------------------------------------
  # Build: Verifies the Docker build (Runs on PRs, Master, Tags)
  # ------------------------------------------------------------------------------------
  build-image:
    needs: filter
    if: needs.filter.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      version_string: ${{ steps.get_repo_info.outputs.version_string }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          lfs: "true"

      - name: Get Repo Info
        id: get_repo_info
        uses: ./.github/actions/get-repo-info
        with:
          fetch-depth: "0"

      - name: Install Dependencies
        run: npm i --only=dev && npm i --prefix ./backend --only=dev

      - name: Build Docker Image (Local Only)
        run: npm run build:docker croudebush/sprout:dev

      # Save the image so the Publish job doesn't have to rebuild it
      - name: Save Docker Image Artifact
        run: docker save croudebush/sprout:dev > sprout-image.tar

      - name: Upload Image Artifact
        uses: actions/upload-artifact@v6
        with:
          name: docker-image
          path: sprout-image.tar
          retention-days: 1

  # ------------------------------------------------------------------------------------
  # Publish: ONLY runs on Master or Tags
  # ------------------------------------------------------------------------------------
  publish-image:
    needs: [filter, build-image]
    if: |
      needs.filter.outputs.should_run == 'true' && 
      (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6

      - name: Download Image Artifact
        uses: actions/download-artifact@v7
        with:
          name: docker-image

      - name: Load Docker Image
        run: docker load < sprout-image.tar

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push 'dev' tag (Master Only)
        if: github.ref == 'refs/heads/master'
        run: docker push croudebush/sprout:dev

      - name: Tag and Push Release (Tags Only)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          IMAGE_NAME="croudebush/sprout"
          TAG_VERSION="${{ needs.build-image.outputs.version_string }}"
          docker tag $IMAGE_NAME:dev $IMAGE_NAME:$TAG_VERSION
          docker push $IMAGE_NAME:$TAG_VERSION
          docker tag $IMAGE_NAME:dev $IMAGE_NAME:stable
          docker push $IMAGE_NAME:stable

      - name: Update Docker Hub Description
        if: startsWith(github.ref, 'refs/tags/')
        uses: peter-evans/dockerhub-description@v5
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: croudebush/sprout

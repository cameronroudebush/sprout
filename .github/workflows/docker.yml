name: Build and Publish Docker Image

permissions:
  contents: write
  pull-requests: read

on:
  push:
    branches: ["master"]
    tags: ["v*.*.*"]
  pull_request:
    branches: ["*"]

jobs:
  ## ------------------------------------------------------------------------------------
  ##  Filter Job: Decides if the main build job should run.
  ## ------------------------------------------------------------------------------------
  filter:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.decision.outputs.should_run }}
    steps:
      - name: Check if this is a tag push
        id: check_tag
        run: echo "is_tag=${{ startsWith(github.ref, 'refs/tags/') }}" >> $GITHUB_OUTPUT

      # The following steps are skipped for tag pushes to save time.
      - name: Checkout for path analysis
        if: steps.check_tag.outputs.is_tag == 'false'
        uses: actions/checkout@v4

      - name: Get changed files
        if: steps.check_tag.outputs.is_tag == 'false'
        id: changed_files
        uses: tj-actions/changed-files@v47
        with:
          files: |
            frontend/**
            backend/**

      - name: Decide whether to proceed
        id: decision
        run: |
          if [[ "${{ steps.check_tag.outputs.is_tag }}" == "true" || "${{ steps.changed_files.outputs.any_changed }}" == "true" ]]; then
            echo "Proceeding: A tag was pushed or relevant files changed."
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "Skipping: Not a tag push and no changes in frontend/ or backend/."
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi

  ## ------------------------------------------------------------------------------------
  ##  Build and Publish Job
  ## ------------------------------------------------------------------------------------
  build-and-publish:
    # This job only runs if the 'filter' job gives the green light.
    needs: filter
    if: needs.filter.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: "true"

      - name: Get Repo Info
        id: get_repo_info
        uses: ./.github/actions/get-repo-info
        with:
          fetch-depth: "0"

      - name: NPM Install
        run: npm i --only=dev && npm i --prefix ./backend --only=dev

      - name: Login to Docker Hub
        # Condition ensures this only runs on a PUSH to master or a PUSH of a tag.
        if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker Image
        run: |
          IMAGE_NAME="croudebush/sprout"
          npm run build:docker $IMAGE_NAME:dev

      - name: Push 'dev' tag to Docker Hub
        # This step only runs on pushes to the master branch.
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        run: |
          IMAGE_NAME="croudebush/sprout"
          docker push $IMAGE_NAME:dev

      - name: Tag and Push Version and Stable Tags
        # This step only runs when a tag is pushed.
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          IMAGE_NAME="croudebush/sprout"
          TAG_VERSION="${{ steps.get_repo_info.outputs.version_string }}"
          docker tag $IMAGE_NAME:dev $IMAGE_NAME:$TAG_VERSION
          docker push $IMAGE_NAME:$TAG_VERSION
          docker tag $IMAGE_NAME:dev $IMAGE_NAME:stable
          docker push $IMAGE_NAME:stable

      - name: Update Docker Hub Description
        # This step only runs when a tag is pushed.
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        uses: peter-evans/dockerhub-description@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: croudebush/sprout

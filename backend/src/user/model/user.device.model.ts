import { DatabaseDecorators } from "@backend/database/decorators";
import { DatabaseBase } from "@backend/database/model/database.base";
import { DevicePlatform } from "@backend/user/model/user.device.type";
import { User } from "@backend/user/model/user.model";
import { ApiHideProperty } from "@nestjs/swagger";
import { Exclude } from "class-transformer";
import { IsEnum } from "class-validator";
import { ManyToOne } from "typeorm";

/** This class tracks individual devices registered to a specific user */
@DatabaseDecorators.entity()
export class UserDevice extends DatabaseBase {
  /** The unique FCM token generated by the device */
  @DatabaseDecorators.column({ nullable: false, unique: true })
  fcmToken: string;

  /** A friendly name for the device */
  @DatabaseDecorators.column({ nullable: true })
  deviceName?: string;

  /** Track the platform to handle specific payload requirements later */
  @DatabaseDecorators.column({
    type: "varchar",
    default: DevicePlatform.ANDROID,
  })
  @IsEnum(DevicePlatform)
  platform: DevicePlatform;

  /** The date this device was registered */
  @DatabaseDecorators.column({ nullable: false })
  lastSeenAt: Date = new Date();

  /** The user this device belongs to */
  @ManyToOne(() => User, (u) => u.id, { onDelete: "CASCADE" })
  @ApiHideProperty()
  @Exclude()
  user: User;

  constructor(user: User, fcmToken: string, platform: DevicePlatform, deviceName?: string) {
    super();
    this.user = user;
    this.fcmToken = fcmToken;
    this.platform = platform;
    this.deviceName = deviceName;
  }
}
